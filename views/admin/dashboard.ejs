<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elite Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Poppins,sans-serif}
body{background:#0f172a;color:#fff;display:flex}
.sidebar{width:240px;background:#111827;min-height:100vh;padding:20px}
.sidebar h2{margin-bottom:30px;color:#38bdf8}
.sidebar a{display:block;color:#cbd5e1;text-decoration:none;margin:15px 0;transition:.3s}
.sidebar a:hover{color:#38bdf8}
.main{flex:1;padding:30px;overflow-y:auto}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
.card{background:#1e293b;padding:20px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,.3)}
.card h3{font-size:14px;color:#94a3b8}
.card h1{font-size:26px;margin-top:10px}
.section{margin-top:40px}
.section h2{margin-bottom:15px;color:#38bdf8}
table{width:100%;border-collapse:collapse;background:#1e293b;border-radius:10px;overflow:hidden;margin-bottom:30px}
th,td{padding:12px;text-align:center;border-bottom:1px solid #334155;font-size:14px}
button{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-size:13px}
.approve{background:#16a34a;color:#fff}
.decline{background:#dc2626;color:#fff}
.balanceBtn{background:#2563eb;color:#fff}
input[type="number"]{padding:5px;width:80px;border-radius:5px;border:none;text-align:center}
.chat-box{position:fixed;right:20px;bottom:20px;width:350px;height:400px;background:#1e293b;border-radius:12px;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.5)}
.chat-header{padding:10px;background:#2563eb;text-align:center;font-weight:bold;border-radius:12px 12px 0 0}
.chat-messages{flex:1;overflow-y:auto;padding:10px;font-size:13px}
.chat-input{display:flex;border-top:1px solid #334155}
.chat-input input{flex:1;border:none;padding:10px;background:#1e293b;color:#fff}
.chat-input button{background:#16a34a;color:white;border:none;padding:10px}
</style>
</head>
<body>

<div class="sidebar">
<h2>ADMIN PANEL</h2>
<a href="#">Dashboard</a>
<a href="/admin/logout">Logout</a>
</div>

<div class="main">

<div class="topbar">
<h1>Welcome <%= admin.email %> ðŸ‘‘</h1>
</div>

<!-- ===================== STATS ===================== -->
<div class="cards">
<div class="card">
<h3>Total Users</h3>
<h1 id="totalUsers">0</h1>
</div>
<div class="card">
<h3>Total Deposits</h3>
<h1 id="totalDeposits">0</h1>
</div>
<div class="card">
<h3>Total Withdrawals</h3>
<h1 id="totalWithdrawals">0</h1>
</div>
<div class="card">
<h3>Revenue</h3>
<h1 id="revenue">0</h1>
</div>
</div>

<canvas id="revenueChart" height="80"></canvas>

<!-- ===================== USERS ===================== -->
<div class="section">
<h2>All Users</h2>
<table>
<tr>
<th>ID</th>
<th>Email</th>
<th>Balance</th>
<th>Adjust</th>
<th>Chat</th>
</tr>
<% users.forEach(user=>{ %>
<tr>
<td><%= user.id %></td>
<td><%= user.email %></td>
<td>$<%= user.balance %></td>
<td>
<input type="number" id="amount_<%= user.id %>" placeholder="+/-">
<button class="balanceBtn" onclick="updateBalance(<%= user.id %>)">Update</button>
</td>
<td><button onclick="selectUser(<%= user.id %>, '<%= user.email %>')">Chat</button></td>
</tr>
<% }) %>
</table>
</div>

<!-- ===================== PENDING DEPOSITS ===================== -->
<div class="section">
<h2>Pending Deposits</h2>
<table>
<tr>
<th>User</th>
<th>Amount</th>
<th>Action</th>
</tr>
<% pendingDeposits.forEach(d=>{ %>
<tr>
<td><%= d.user_id %></td>
<td>$<%= d.amount %></td>
<td>
<button class="approve" onclick="process('deposit',<%= d.id %>,'approve')">Approve</button>
<button class="decline" onclick="process('deposit',<%= d.id %>,'decline')">Decline</button>
</td>
</tr>
<% }) %>
</table>
</div>

<!-- ===================== USER ACTIVITY LOGS ===================== -->
<div class="section" id="activityLogs">
<h2>User Activity Logs</h2>
<p>Select a user to view activity.</p>
</div>

</div>

<!-- ===================== CHAT ===================== -->
<input type="hidden" id="selectedUserId" value="">
<div class="chat-box">
<div class="chat-header">Admin Chat</div>
<div class="chat-messages" id="chatMessages"></div>
<div class="chat-input">
<input type="text" id="chatInput" placeholder="Type message">
<button onclick="sendMessage()">Send</button>
</div>
</div>

<script>
let chatInterval;

async function loadStats(){
  const res = await fetch("/admin/stats");
  const data = await res.json();
  document.getElementById("totalUsers").innerText = data.totalUsers;
  document.getElementById("totalDeposits").innerText = "$"+data.totalDeposits;
  document.getElementById("totalWithdrawals").innerText = "$"+data.totalWithdrawals;
  document.getElementById("revenue").innerText = "$"+data.revenue;

  new Chart(document.getElementById("revenueChart"),{
    type:"bar",
    data:{
      labels:["Deposits","Withdrawals","Revenue"],
      datasets:[{data:[data.totalDeposits,data.totalWithdrawals,data.revenue]}]
    }
  });
}

async function process(type,id,action){
  await fetch(`/admin/${type}/${id}/${action}`,{method:"POST"});
  location.reload();
}

async function updateBalance(id){
  const amount = document.getElementById("amount_"+id).value;
  await fetch(`/admin/balance/${id}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({amount})
  });
  location.reload();
}

// ===================== CHAT =====================
function selectUser(id, email){
  document.getElementById("selectedUserId").value = id;
  document.querySelector(".chat-header").innerText = "Chat with " + email;
  document.getElementById("chatMessages").innerHTML = "";

  loadActivity(id);

  if(chatInterval) clearInterval(chatInterval);
  chatInterval = setInterval(()=>loadChat(id), 2000);
}

async function loadChat(userId){
  const res = await fetch(`/admin/chat/${userId}`);
  const messages = await res.json();
  const chatBox = document.getElementById("chatMessages");
  chatBox.innerHTML = "";
  messages.forEach(m=>{
    const div = document.createElement("div");
    div.innerHTML = `<b>${m.sender}:</b> ${m.message}`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function sendMessage(){
  const msg = document.getElementById("chatInput").value;
  const userId = document.getElementById("selectedUserId").value;
  if(!msg || !userId) return alert("Select a user first");
  await fetch(`/admin/chat/${userId}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({message:msg})
  });
  document.getElementById("chatInput").value="";
  loadChat(userId);
}

// ===================== ACTIVITY LOGS =====================
async function loadActivity(userId){
  const res = await fetch(`/admin/activity/${userId}`);
  const data = await res.json();
  const activityDiv = document.getElementById("activityLogs");
  activityDiv.innerHTML = `<h2>Activity Logs</h2>`;
  if(data.length===0){ activityDiv.innerHTML += "<p>No activity yet.</p>"; return; }
  let html = `<table>
    <tr><th>Type</th><th>Amount</th><th>Status</th><th>Date</th></tr>`;
  data.forEach(act=>{
    html += `<tr>
      <td>${act.type||'N/A'}</td>
      <td>${act.amount||'-'}</td>
      <td>${act.status||'-'}</td>
      <td>${act.created_at}</td>
    </tr>`;
  });
  html += `</table>`;
  activityDiv.innerHTML += html;
}

loadStats();
</script>

</body>
</html>