<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<style>
body { font-family: 'Poppins', sans-serif; margin:0; padding:0; background:#0a0a0a; color:#fff; }
h2,h3 { color: gold; }
.sidebar { position: fixed; width: 250px; height: 100vh; background:#111; padding: 20px; }
.sidebar a { display:block; padding:10px; color:#ccc; margin-bottom:5px; }
.sidebar a:hover { background: gold; color:#000; }
.main { margin-left:270px; padding:20px; }
.card { background:#222; padding:15px; margin-bottom:20px; border-radius:10px; }
button { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
button.approve { background:green; color:#fff; }
button.decline { background:red; color:#fff; }
input[type=number] { width:80px; padding:5px; margin-right:5px; }
.user-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; padding:5px; background: rgba(255,215,0,0.05); border-radius:5px; }
.chat-column { background:#111; padding:10px; border-radius:10px; height:300px; overflow-y:auto; }
#chatInput { width:100%; padding:8px; margin-top:5px; border-radius:5px; border:none; }
</style>
</head>
<body>

<!-- ================= SIDEBAR ================= -->
<div class="sidebar">
    <h2>ADMIN DASHBOARD</h2>
    <a href="/admin/dashboard">Dashboard</a>
    <a href="/admin/logout">Logout</a>
</div>

<div class="main">
    <h3>üìä Stats Overview</h3>
    <div class="card" id="statsCard">
        Loading stats...
    </div>

    <h3>üßë‚Äçüíº Users</h3>
    <div class="card" id="usersList">
        <% users.forEach(user => { %>
        <div class="user-row" data-userid="<%= user.id %>">
            <span><%= user.fullname %> ($<%= user.balance %>)</span>
            <input type="number" placeholder="Adjust balance" class="balanceInput">
            <button class="balanceBtn">Update</button>
            <button class="chatBtn">Chat</button>
        </div>
        <% }) %>
    </div>

    <h3>üí∞ Pending Deposits</h3>
    <div class="card" id="pendingDeposits">
        <% pendingDeposits.forEach(dep => { %>
        <div class="user-row" data-id="<%= dep.id %>" data-user="<%= dep.user_id %>">
            <span><%= dep.amount %> USD - <%= dep.user_id %></span>
            <button class="approve" data-action="approve">Approve</button>
            <button class="decline" data-action="decline">Decline</button>
        </div>
        <% }) %>
    </div>

    <h3>üí¨ Live Chat</h3>
    <div class="card">
        <div class="chat-column" id="chatColumn"></div>
        <input type="text" id="chatInput" placeholder="Type message...">
    </div>
</div>

<script>
const socket = io();
let currentChatUser = null;

// ---------------- STATS ----------------
async function loadStats() {
    try {
        const res = await axios.get('/admin/stats');
        const stats = res.data;
        document.getElementById('statsCard').innerHTML = `
            <p>Total Users: ${stats.totalUsers}</p>
            <p>Total Deposits: $${stats.totalDeposits}</p>
            <p>Total Withdrawals: $${stats.totalWithdrawals}</p>
            <p>Revenue: $${stats.revenue}</p>
        `;
    } catch(err) { console.error(err); }
}
loadStats();

// ---------------- BALANCE UPDATE ----------------
document.querySelectorAll('.balanceBtn').forEach(btn => {
    btn.addEventListener('click', async () => {
        const parent = btn.parentElement;
        const userId = parent.dataset.userid;
        const input = parent.querySelector('.balanceInput');
        const amount = Number(input.value);
        if (!amount) return alert('Enter valid amount');
        try {
            const res = await axios.post(`/admin/balance/${userId}`, { amount });
            alert('New balance: ' + res.data.newBalance);
            input.value = '';
            loadStats();
        } catch(err) { console.error(err); alert('Error'); }
    });
});

// ---------------- PROCESS PENDING DEPOSITS ----------------
document.querySelectorAll('#pendingDeposits button').forEach(btn => {
    btn.addEventListener('click', async () => {
        const parent = btn.parentElement;
        const id = parent.dataset.id;
        const action = btn.dataset.action;
        try {
            await axios.post(`/admin/deposit/${id}/${action}`);
            alert(`Deposit ${action}d`);
            parent.remove();
            loadStats();
        } catch(err) { console.error(err); alert('Error'); }
    });
});

// ---------------- CHAT ----------------
const chatColumn = document.getElementById('chatColumn');
const chatInput = document.getElementById('chatInput');

document.querySelectorAll('.chatBtn').forEach(btn => {
    btn.addEventListener('click', async () => {
        const parent = btn.parentElement;
        currentChatUser = parent.dataset.userid;
        chatColumn.innerHTML = '';
        const res = await axios.get(`/admin/chat/${currentChatUser}`);
        res.data.forEach(msg => {
            const div = document.createElement('div');
            div.textContent = msg.sender.toUpperCase() + ': ' + msg.message;
            chatColumn.appendChild(div);
        });
    });
});

chatInput.addEventListener('keypress', e => {
    if(e.key==='Enter' && currentChatUser && chatInput.value.trim()!==''){
        const text = chatInput.value.trim();
        socket.emit('admin-message', { userId: currentChatUser, text });
        const div = document.createElement('div');
        div.textContent = 'ADMIN: ' + text;
        chatColumn.appendChild(div);
        chatInput.value = '';
    }
});

// ---------------- RECEIVE MESSAGES ----------------
socket.on('receive-message', msg => {
    if(currentChatUser == msg.userId){
        const div = document.createElement('div');
        div.textContent = msg.sender.toUpperCase() + ': ' + msg.text;
        chatColumn.appendChild(div);
    }
});
</script>

</body>
</html>
